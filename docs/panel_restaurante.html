<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Restaurante</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-outline-danger" onclick="logout()">Cerrar sesión</button>
        </div>
        <h2>Panel de Administración del Restaurante</h2>
        <p id="welcome"></p>

        <h4>Editar capacidad del restaurante</h4>
        <form id="edit-capacity-form" class="mb-4">
            <input type="number" id="total-tables" placeholder="Número de mesas reservables" required class="form-control mb-2">
            <input type="number" id="total-capacity" placeholder="Capacidad total de comensales" required class="form-control mb-2">
            <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </form>

        <h4>Reservas recibidas</h4>
        <ul id="reservations-list" class="list-group"></ul>
    </div>

    <script src="app.js"></script>
    <script>
    let restauranteId = null;

async function loadPanel() {
    // Recupera el token y el rol
    const token = localStorage.getItem('access_token');
    const role = localStorage.getItem('user_role');
    if (role !== 'restaurante') {
        window.location.href = 'index.html';
        return;
    }

    // Llama al backend para obtener el restaurante del usuario autenticado
    const response = await fetch('https://sistemadereservas-d1t5.onrender.com/my-restaurant', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    const result = await response.json();
    if (!response.ok || !result || !result.id) {
        alert('No tienes restaurante asociado. Contacta con el administrador.');
        return;
    }
    restauranteId = result.id;
    document.getElementById('welcome').textContent = `Bienvenido, ${result.email || ''}`;
    document.getElementById('total-tables').value = result.total_tables || '';
    document.getElementById('total-capacity').value = result.total_capacity || '';
    // Aquí podrías llamar a loadReservations() si lo adaptas también
}

    // Guardar cambios de capacidad
    document.getElementById('edit-capacity-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!restauranteId) return;
    const total_tables = parseInt(document.getElementById('total-tables').value, 10);
    const total_capacity = parseInt(document.getElementById('total-capacity').value, 10);

    if (isNaN(total_tables) || isNaN(total_capacity)) {
        alert('Introduce valores numéricos válidos.');
        return;
    }

    const token = localStorage.getItem('access_token');
    const response = await fetch(`https://sistemadereservas-d1t5.onrender.com/restaurants/${restauranteId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ total_tables, total_capacity })
    });

    const result = await response.json();

    if (!response.ok) {
        alert(result.error || 'Error al guardar');
    } else {
        alert('Datos actualizados');
    }
});

    // Mostrar reservas recibidas (solo futuras)
    async function loadReservations() {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`https://sistemadereservas-d1t5.onrender.com/restaurants/${restauranteId}/reservations`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        const reservations = await response.json();
        const list = document.getElementById('reservations-list');
        list.innerHTML = '';
        if (reservations && reservations.length > 0) {
            reservations.forEach(r => {
                list.innerHTML += `<li class="list-group-item">
                    <strong>${r.reservation_time.replace('T', ' ').substring(0, 16)}</strong> - ${r.number_of_guests} comensales<br>
                    Nombre reserva: ${r.reservation_name || ''}<br>
                    Teléfono: ${r.phone || ''}<br>
                    Tarjeta: ${r.credit_card || ''}
                </li>`;
            });
        } else {
            list.innerHTML = '<li class="list-group-item">No hay reservas futuras.</li>';
        }
    }

    await loadPanel();
    loadReservations();
    </script>
</body>
</html>