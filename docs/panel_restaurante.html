<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Restaurante</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-outline-danger" onclick="logout()">Cerrar sesión</button>
        </div>
        <h2>Panel de Administración del Restaurante</h2>
        <p id="welcome"></p>

        <h4>Editar capacidad del restaurante</h4>
        <form id="edit-capacity-form" class="mb-4">
            <input type="number" id="total-tables" placeholder="Número de mesas reservables" required class="form-control mb-2">
            <input type="number" id="total-capacity" placeholder="Capacidad total de comensales" required class="form-control mb-2">
            <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </form>

        <h4>Reservas recibidas</h4>
        <ul id="reservations-list" class="list-group"></ul>
    </div>

    <script src="app.js"></script>
    <script>
    let restauranteId = null;

    // Cargar datos del restaurante y mostrar email/capacidad
    async function loadPanel() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { data: profile } = await supabaseClient.from('profiles').select('email').eq('id', user.id).single();
        document.getElementById('welcome').textContent = `Bienvenido, ${profile?.email || ''}`;

        // Buscar restaurante asociado a este usuario
        const { data: restaurantes } = await supabaseClient.from('restaurants').select('*').eq('email', profile.email);
        if (!restaurantes || restaurantes.length === 0) {
            alert('No tienes restaurante asociado. Contacta con el administrador.');
            return;
        }
        const restaurante = restaurantes[0];
        restauranteId = restaurante.id;

        // Rellenar formulario con valores actuales
        document.getElementById('total-tables').value = restaurante.total_tables || '';
        document.getElementById('total-capacity').value = restaurante.total_capacity || '';

        loadReservations();
    }

    // Guardar cambios de capacidad
    document.getElementById('edit-capacity-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!restauranteId) return;
    const total_tables = parseInt(document.getElementById('total-tables').value, 10);
    const total_capacity = parseInt(document.getElementById('total-capacity').value, 10);

    // Validación extra
    if (isNaN(total_tables) || isNaN(total_capacity)) {
        alert('Introduce valores numéricos válidos.');
        return;
    }

    console.log('Actualizando restaurante:', restauranteId, total_tables, total_capacity);
    console.log('typeof total_tables:', typeof total_tables, total_tables);
    console.log('typeof total_capacity:', typeof total_capacity, total_capacity);
    const { error } = await supabaseClient.from('restaurants').update({
        total_tables, total_capacity
    }).eq('id', restauranteId);
    if (error) {
        console.error('Error al guardar:', error);
        alert('Error al guardar: ' + error.message);
    } else {
        alert('Datos actualizados');
    }
});

    // Mostrar reservas recibidas (solo futuras)
    async function loadReservations() {
        const now = new Date().toISOString();
        const { data: reservations } = await supabaseClient
            .from('reservations')
            .select('*, users(name, email)')
            .eq('restaurant_id', restauranteId)
            .gte('reservation_time', now)
            .order('reservation_time', { ascending: true });
        const list = document.getElementById('reservations-list');
        list.innerHTML = '';
        if (reservations && reservations.length > 0) {
            reservations.forEach(r => {
                list.innerHTML += `<li class="list-group-item">
                    <strong>${r.reservation_time.replace('T', ' ').substring(0, 16)}</strong> - ${r.number_of_guests} comensales<br>
                    Nombre reserva: ${r.reservation_name || ''}<br>
                    Teléfono: ${r.phone || ''}<br>
                    Tarjeta: ${r.credit_card || ''}
                </li>`;
            });
        } else {
            list.innerHTML = '<li class="list-group-item">No hay reservas futuras.</li>';
        }
    }

    loadPanel();
    </script>
</body>
</html>